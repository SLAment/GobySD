coords <- read.table("/Users/lorena/Library/CloudStorage/Dropbox/VRwork/Analyses/7_Goby/IFB/06_Map2Reference/results/PomflaTH1xy-vs-fGobFla1_sc.filter.coords", header = F)
chrlens <- read.table("/Users/lorena/Library/CloudStorage/Dropbox/VRwork/Analyses/7_Goby/IFB/06_Map2Reference/data/reference/fGobFla1_ref_seqlen.txt", header = F)
# ============================
# Processing
# ============================
names(coords) <- c("S1", "E1", "S2", "E2", "LEN_R", "LEN_Q", "IDY", "COV_R", "COV_Q", "REF", "QUERY")
names(chrlens) <- c("REF", "LenREF")
# Map the chromosome names to the accession numbers in Genbank
ref_to_chr <- c(
"OZ251410.1" = "chr1",
"OZ251411.1" = "chr2",
"OZ251412.1" = "chr3",
"OZ251415.1" = "chr6",
"OZ251413.1" = "chr4",
"OZ251414.1" = "chr5",
"OZ251416.1" = "chr7",
"OZ251417.1" = "chr8",
"OZ251418.1" = "chr9",
"OZ251419.1" = "chr10",
"OZ251420.1" = "chr11",
"OZ251421.1" = "chr12",
"OZ251422.1" = "chr13",
"OZ251423.1" = "chr14",
"OZ251424.1" = "chr15",
"OZ251425.1" = "chr16",
"OZ251426.1" = "chr17",
"OZ251427.1" = "chr18",
"OZ251428.1" = "chr19",
"OZ251429.1" = "chr20",
"OZ251430.1" = "chr21",
"OZ251431.1" = "chr22",
"OZ251432.1" = "chr23",
"OZ251433.1" = "mt" )
coords$Chromosome <- ref_to_chr[coords$REF]
chrlens$Chromosome <- ref_to_chr[chrlens$REF]
coords <- merge(coords, chrlens, by = c("REF", "Chromosome"))
# I'm not interested in the mitochondria
coords <- coords %>% filter(Chromosome != "mt")
## Sort the chromosome names with natural sorting
chr_levels <- unique(coords$Chromosome)
# ============================
# Load the necessary libraries
# ============================
library(ggplot2, quietly = TRUE)
library(dplyr, warn.conflicts = FALSE)
library(scales) # for the palettes
# Map the chromosome names to the accession numbers in Genbank
ref_to_chr <- c(
"OZ251410.1" = "chr1",
"OZ251411.1" = "chr2",
"OZ251412.1" = "chr3",
"OZ251415.1" = "chr6",
"OZ251413.1" = "chr4",
"OZ251414.1" = "chr5",
"OZ251416.1" = "chr7",
"OZ251417.1" = "chr8",
"OZ251418.1" = "chr9",
"OZ251419.1" = "chr10",
"OZ251420.1" = "chr11",
"OZ251421.1" = "chr12",
"OZ251422.1" = "chr13",
"OZ251423.1" = "chr14",
"OZ251424.1" = "chr15",
"OZ251425.1" = "chr16",
"OZ251426.1" = "chr17",
"OZ251427.1" = "chr18",
"OZ251428.1" = "chr19",
"OZ251429.1" = "chr20",
"OZ251430.1" = "chr21",
"OZ251431.1" = "chr22",
"OZ251432.1" = "chr23",
"OZ251433.1" = "mt" )
coords$Chromosome <- ref_to_chr[coords$REF]
chrlens$Chromosome <- ref_to_chr[chrlens$REF]
coords <- merge(coords, chrlens, by = c("REF", "Chromosome"))
# I'm not interested in the mitochondria
coords <- coords %>% filter(Chromosome != "mt")
## Sort the chromosome names with natural sorting
chr_levels <- unique(coords$Chromosome)
chr_nums <- as.numeric(gsub("chr", "", chr_levels))
# Get naturally sorted, unique chromosome names
sorted_chr <- chr_levels[order(chr_nums)] # use the chromosome numbers as indexes for ordering
coords$Chromosome <- factor(coords$Chromosome, levels = sorted_chr)
dotplotter2 <- function(data, linesize = 1.5, minaligncov = 100000, minidentity = 96, minLENQ = 10000){
## First, select the contigs that have long alignments
datacov <- data %>% group_by(QUERY, REF) %>% summarise(totalalign = sum(LEN_Q))
selectedhits <- datacov %>% filter(totalalign > minaligncov) %>% pull(QUERY) # Just take the contigs with decent alignment lengths
data <- merge(data, datacov, by = c("QUERY", "REF"))
# Asign colors before ordering the contigs so there is more contrast
n_colors <- length(selectedhits)
my_colors <- hue_pal()(n_colors)  # Generates `n` evenly spaced colors
names(my_colors) <- selectedhits       # Name each color by contig
## Next, order the contigs to match the reference
# Compute first hit (or earliest reference coordinate) per query contig
query_order <- data %>%
filter(QUERY %in% selectedhits, IDY > minidentity, LEN_Q > minLENQ) %>%
group_by(REF, QUERY) %>%
summarize(min_ref = min(pmin(S1, E1)), .groups = "drop") %>%
arrange(REF, min_ref) %>%
pull(QUERY) %>% unique() %>% rev()
# Recover the lost contigs
query_order <- c(setdiff(selectedhits, query_order), query_order )
# Change the factors to match the order
data$QUERY <- factor(data$QUERY, levels = query_order)
dotp <- ggplot(data %>% filter(QUERY %in% selectedhits)) +
# Alignment segments
geom_segment(aes(x = S1, xend = E1, y = S2, yend = E2, color = QUERY), linewidth = 1.5) +
theme_minimal() +
facet_grid(QUERY ~ REF, scales="free", space = "free") +
theme(axis.text.x = element_text(angle = 45, vjust = 0.8),
# panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.y = element_blank(),
strip.text.y = element_text(angle = 0), # make strip labels horizontal
axis.line = element_line(color='black'),
panel.spacing = unit(0.05, "lines"), # make the facets closer
legend.position="none") +
scale_color_manual(values = my_colors) +
# scale_color_manual(values = c("forward" = "cyan3", "reverse" = "coral2")) +
labs(x = "Reference Coordinate (bp)", y = "Query Coordinate (bp)")
return(dotp)
}
# ============================
# Plotting chr16 only
# ============================
### Chr16 in particular (sex chr)
chr16 <- coords %>% filter(Chromosome == "chr16")
# ============================
# Plotting chr16 only
# ============================
### Chr16 in particular (sex chr)
chr16 <- coords %>% filter(Chromosome == "chr4")
# I want the names of the chromosomes rather than the GenBank accession
chr16$REF2 <- chr16$REF
chr16$REF <- chr16$Chromosome
# Remove these because they are distracting
scfsWithSatDNAalignments <- c("ptg000064l", "ptg000017l", "ptg000013l", "ptg000015l", "ptg000034l", "ptg000363l")
chr16plot <- dotplotter2(chr16 %>% filter(!QUERY %in% scfsWithSatDNAalignments),
minLENQ = 5000) + theme(axis.text.x = element_text(angle = 0))
chr16plot
dotplotter2(chr16)
